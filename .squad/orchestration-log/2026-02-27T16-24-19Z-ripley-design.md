# Orchestration Log: Ripley — Per-Session Conversation History Design

**Timestamp:** 2026-02-27T16:24:19Z  
**Agent:** Ripley (Lead/Architect)  
**Mode:** sync  
**Status:** ✅ completed

## Spawn Details

**Task:** Design per-session conversation history using `IConversationSessionStore` to fix multi-user safety issue identified in codebase analysis.

**Charter Responsibilities:**
- Address blocker #1: Pipeline shared across users
- Create lightweight abstraction avoiding heavy Agent Framework coupling
- Design with future evolution path (Redis, Cosmos, Agent Framework adapters)

## Work Summary

### Design Artifacts Created

1. **Interface Specification:** `IConversationSessionStore.cs`
   - Two async methods: `GetOrCreateSessionAsync`, `RemoveSessionAsync`
   - Works with standard `List<ChatMessage>` — no new types
   - CancellationToken support throughout

2. **Default Implementation:** `InMemoryConversationSessionStore.cs`
   - Thread-safe: `ConcurrentDictionary<string, IList<ChatMessage>>`
   - Sessions keyed by string ID (SignalR connection, user ID, etc.)
   - ~20 lines, zero external dependencies

3. **Integration Points Specified:**
   - `ConversationOptions.SessionId` property (nullable, backward-compatible)
   - `RealtimeConversationPipeline` constructor param reordering
   - `RealtimeServiceCollectionExtensions` DI registration
   - `ProcessSpeechSegmentAsync`, `TrimHistory` refactoring

4. **Usage Examples:**
   - Single-user (default, no code changes)
   - SignalR multi-user (per-connection history, cleanup on disconnect)
   - REST API (user-provided session ID)
   - Custom store replacement pattern

### Architecture Rationale

**Why not `Microsoft.Agents.AI` directly?**
- Package weight and breaking-change churn in preview
- MEAI alignment — using existing `ChatMessage` abstractions
- Future bridge: Thin `AgentSessionConversationStore` adapter possible later

**Thread Safety:**
- `ConcurrentDictionary` for session map ops
- Individual `List<ChatMessage>` per session — sequential processing per connection
- Documented limitation for concurrent access to same session ID

### Decision Recorded
**Decision ID:** `ripley-agentsession-design`  
**File:** `.squad/decisions/inbox/ripley-agentsession-design.md`

---

## Next Steps
1. Dallas implements design
2. Kane writes tests
3. Scribe merges decisions and logs session
