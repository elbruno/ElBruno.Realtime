---
session: issue1-phase1
timestamp: 2026-02-28T18:00:00Z
agent: Kane (Tester)
task: Test Coverage & Benchmarking Infrastructure
status: awaiting-phase2
---

# Kane — Issue #1 Test Coverage & Benchmarking (Phase 1)

## Status Summary

**Phase 1:** No active tasks (benchmarking deferred to Phase 2 per Ripley's triage).  
**Phase 2 Pending:** Path traversal test coverage (Task 1.3) + BenchmarkDotNet project creation (Task 2.1).

## Why Phase 2?

Ripley's triage decomposed work as:
- **Phase 1 (Parallel):** Dallas security, Parker CI fixes, Ripley documentation, Kane inactive
- **Phase 2 (Sequential):** Kane benchmarks (Task 2.1) → Dallas TensorPrimitives validation

This sequencing avoids premature optimization. Task 2.1 (benchmarks) must complete before Task 2.3 (allocation audit) can proceed.

## Current Test Suite Status

**Baseline:** 66 original tests + 14 session store tests = 80 total  
**Coverage:** All core components tested (VAD, STT, session store, DI)  
**TensorPrimitives:** Validated via existing SileroVadTests (normalization logic unchanged)

## Phase 2 Scope (Ready for Execution)

### Task 1.3: Path Traversal Test Coverage
**Owner:** Kane  
**Scope:** `src/ElBruno.Realtime.Tests/ModelManagerSecurityTests.cs` (new)

**What to test:**
1. `WhisperModelManager.EnsureModelAsync(cacheDir: "../attacker")` → `ArgumentException`
2. `SileroModelManager.EnsureModelAsync(cacheDir: "C:\\Windows\\System32")` → `ArgumentException`
3. Verify existing `Path.GetFullPath() + StartsWith()` guards are exercised
4. Edge cases: symlinks (if applicable), UNC paths, relative traversal patterns

**Expected results:** All should throw `ArgumentException` with clear messages.

### Task 2.1: BenchmarkDotNet Project
**Owner:** Kane (primary) + Dallas (C# support)  
**Scope:** New `src/ElBruno.Realtime.Benchmarks/` project

**What to benchmark:**
1. **VadBenchmark.cs:**
   - `DetectSpeechAsync()` throughput (audio frames/sec)
   - Measure allocations (Gen0, Gen1, Gen2 collections)
   - Before/after TensorPrimitives optimization (Dallas completed Task 2.2)

2. **SttBenchmark.cs:**
   - `TranscribeAsync()` latency (ms per audio chunk)
   - Compare different audio lengths (short vs long form)

3. **PipelineBenchmark.cs:**
   - Full `ConverseAsync()` turn latency (mock LLM, real VAD/STT)
   - Allocations per turn

**Test data:** Synthetic audio (1–5 second clips, 16kHz 16-bit mono PCM)

**Integration:** Include in `dotnet build` but not `dotnet test` (benchmarks are slow; manual trigger or nightly only).

---

## Phase 1 Deliverables

✅ **Status:** Monitoring Dallas TensorPrimitives optimization  
✅ **Tests Passing:** 80/80 (all TFMs)  
✅ **No blockers:** Ready to proceed with Phase 2

---

## Handoff Notes for Phase 2

1. Dallas has completed Task 2.2 (TensorPrimitives) — all tests pass, build clean
2. Path traversal guards exist in both ModelManagers (lines 48–51 Whisper, 30–33 Silero) but are untested
3. BenchmarkDotNet project will validate TensorPrimitives speedup quantitatively
4. Allocation audit (Task 2.3) gated on benchmark findings — only proceed if benchmarks show allocations are a bottleneck

---

## Recommended Execution Order (Phase 2)

```
1. Task 2.1: Create BenchmarkDotNet project
   - Measure baseline (current TensorPrimitives implementation)
   - Document allocation hotspots

2. Task 1.3: Add ModelManagerSecurityTests
   - Full test coverage for path traversal guards
   - Can run in parallel with Task 2.1

3. Task 2.3: Allocation audit (CONDITIONAL)
   - Only if Task 2.1 benchmarks show allocations > 5% of runtime
   - Use ArrayPool for frequently-allocated buffers
```

---

**Phase 1 Await → Phase 2 Ready.** All prior work clean; no blockers to proceeding.
